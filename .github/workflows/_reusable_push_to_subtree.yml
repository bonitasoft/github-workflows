name: Push to subtree

on:
  workflow_call:
    inputs:
      target:
        type: string
        required: true
        description: |
          The target repository name whew to push the subtree repository.
          eg: bonitasoft/bonita-studio 
      prefix: 
        type: string
        required: false
        default: community
        description: |
          The prefix used for the community subtree. 
          Default is 'community'
      reference: 
        type: string
        required: false
        default: dev
        description: |
          The reference to push to the git subtree. 
          Default is 'dev'. Can't be a tag.
    secrets:
      KSM_CONFIG:
        required: true
      BONITA_CI_PAT:
        required: true

jobs:
  push-to-subtree:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Cache splitsh-lite
        id: splitsh-cache
        uses: actions/cache@v4
        with:
          path: './.splitsh'
          key: '${{ runner.os }}-splitsh-d-101'
      - uses: bonitasoft/git-setup-action@v1
        with:
          keeper-secret-config: ${{ secrets.KSM_CONFIG }}
      - name: Create configuration file
        run: |
         jo sub-splits=$(jo -a $(jo name=community directory=${{ inputs.prefix }} target=git@github.com/${{ inputs.target }}.git)) > ./config.subsplit-publish.json
      - uses: frankdejonge/use-subsplit-publish@1.1.0
        with:
          source-branch: ${{ inputs.reference }}
          config-path: './config.subsplit-publish.json'
          splitsh-path: './.splitsh/splitsh-lite'
      # - name: Split community subtree
      #   uses: claudiodekker/splitsh-action@v1.0.0
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.BONITA_CI_PAT }}
      #   with:
      #     prefix: ${{ inputs.prefix }}
      #     remote: ${{ inputs.remote }}
      #     reference: ${{ inputs.reference }}
      #     as_tag: false