name: Push to subtree

on:
  workflow_call:
    inputs:
      ref: 
        type: string
        default: ${{ github.ref }}
        required: false
      ref_name: 
        type: string
        default: ${{ github.ref_name }}
        required: false
      remote:
        type: string
        required: true
        description: |
          The remote url of the subtree repository.
          eg: https://github.com/bonitasoft/bonita-studio.git 
      prefix: 
        type: string
        required: false
        default: community
        description: |
          The prefix used for the community subtree. 
          Default is 'community'
    secrets:
      BONITA_CI_PAT:
        required: true

jobs:
  push-to-subtree:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          # Required: checkout v6 sets up credentials that override token-embedded URLs
          persist-credentials: false

      - name: Install splitsh-lite
        run: |
          curl -L https://github.com/splitsh/lite/releases/download/v1.0.1/lite_linux_amd64.tar.gz | tar -xz
          sudo mv splitsh-lite /usr/local/bin/

      # Inspired by https://github.com/claudiodekker/splitsh-action
      # Replaced with native implementation for actions/checkout@v6 compatibility
      - name: Split and push to subtree
        env:
          GITHUB_TOKEN: ${{ secrets.BONITA_CI_PAT }}
        run: |
          set -ex

          prefix="${{ inputs.prefix }}"
          remote="${{ inputs.remote }}"
          reference="${{ inputs.ref_name }}"
          as_tag="${{ startsWith(inputs.ref, 'refs/tags/') }}"

          # Convert remote URL to use HTTPS with token authentication
          remote_https=$(echo "$remote" | sed 's|^git@github.com:|https://github.com/|' | sed "s|^https://github.com/|https://${GITHUB_TOKEN}@github.com/|")

          # Clear any existing HTTP headers (ignore if not set - checkout v6 compatibility)
          git config --local --unset-all http.https://github.com/.extraheader || true

          # Split the repository
          git remote add splitsh_target_remote "$remote_https"
          SHA1=$(splitsh-lite --prefix="$prefix")

          # Push the split repository to the remote
          if [ "$as_tag" = "true" ]; then
            git push splitsh_target_remote "$SHA1:refs/tags/$reference" -f --verbose
          else
            git push splitsh_target_remote "$SHA1:refs/heads/$reference" -f --verbose
          fi
